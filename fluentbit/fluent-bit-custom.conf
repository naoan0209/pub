# =============================================================
# ** FluentBitコンフィグ **
#
# コンテナ名にApacheなら「apache」Tomcatなら「tomcat」が含まれていること。
# アプリケーションのログ種別は半角スペース区切りの4番目のフィールドに存在。
# 変数はすべてECS環境変数で指定。
# FluentBit自身が出力するログのログレベルは環境変数FLB_LOG_LEVELで指定。
#
# =============================================================
# -------------------------------------------------------------
# SERVICE
# -------------------------------------------------------------
[SERVICE]
    Flush              1
    Grace              30
    Parsers_File       /fluent-bit/parsers.conf

# -------------------------------------------------------------
# FILTER
# -------------------------------------------------------------
# ALBヘルスチェックログを除外
[FILTER]
    Name               grep
    Match              *-firelens-*
    Exclude            log ^(?=.*ELB-HealthChecker\/2\.0).*$

# スタックトレース①マルチラインでログを結合
[FILTER]
    Name               multiline
    Match              *tomcat*-firelens-*
    multiline.key_content log
    multiline.parser   stacktrace

# スタックトレース②結合したログをマッチング
[FILTER]
    Name               rewrite_tag
    Match              *tomcat*-firelens-*
    Rule               $log "^\d{4}-\d{2}-\d{2}[ ]\d{2}:\d{2}:\d{2},\d{3}.+\n[ ]+?at[ ]" app-stacktrace-$container_id false

# トランザクションログ
[FILTER]
    Name               rewrite_tag
    Match              *tomcat*-firelens-*
    Rule               $log "^(?:\S+?[ ]){3}txn[ ]" app-txn-$container_id false

# インターフェースログ
[FILTER]
    Name               rewrite_tag
    Match              *tomcat*-firelens-*
    Rule               $log "^(?:\S+?[ ]){3}if[ ]" app-if-$container_id false

# Tomcatミドルウェア標準出力ログ
[FILTER]
    Name               rewrite_tag
    Match              *tomcat*-firelens-*
    Rule               $source stdout tomcat-stdout-$container_id false

# Tomcatミドルウェア標準エラー出力ログ
[FILTER]
    Name               rewrite_tag
    Match              *tomcat*-firelens-*
    Rule               $source stdout tomcat-stderr-$container_id false

# Apacheアクセスログ
[FILTER]
    Name               rewrite_tag
    Match              *apache*-firelens-*
    Rule               $source stdout apache-stdout-$container_id false

# Apacheエラーログ
[FILTER]
    Name               rewrite_tag
    Match              *apache*-firelens-*
    Rule               $source stderr apache-stderr-$container_id false

# -------------------------------------------------------------
# OUTPUT
# -------------------------------------------------------------
# スタックトレース
[OUTPUT]
    Name               cloudwatch_logs
    Match              app-stacktrace-*
    region             ${AWS_REGION}
    log_group_name     /ecs/component/app/stacktrace
    log_stream_prefix  ${SERVICE_NAME}
    auto_create_group  true
    log_key            log

# トランザクションログ
[OUTPUT]
    Name               cloudwatch_logs
    Match              app-txn-*
    region             ${AWS_REGION}
    log_group_name     /ecs/component/app/txn
    log_stream_prefix  ${SERVICE_NAME}
    auto_create_group  true
    log_key            log

# インターフェースログ
[OUTPUT]
    Name               cloudwatch_logs
    Match              app-if-*
    region             ${AWS_REGION}
    log_group_name     /ecs/component/app/if
    log_stream_prefix  ${SERVICE_NAME}
    auto_create_group  true
    log_key            log

# Tomcatミドルウェア標準出力ログ
[OUTPUT]
    Name               cloudwatch_logs
    Match              tomcat-stdout-*
    region             ${AWS_REGION}
    log_group_name     /ecs/component/mw/tomcat/stdout
    log_stream_prefix  ${SERVICE_NAME}
    auto_create_group  true
    log_key            log

# Tomcatミドルウェア標準出力エラーログ
[OUTPUT]
    Name               cloudwatch_logs
    Match              tomcat-stderr-*
    region             ${AWS_REGION}
    log_group_name     /ecs/component/mw/tomcat/stderr
    log_stream_prefix  ${SERVICE_NAME}
    auto_create_group  true

# Apacheアクセスログ
[OUTPUT]
    Name               cloudwatch_logs
    Match              apache-stdout-*
    region             ${AWS_REGION}
    log_group_name     /ecs/component/mw/apache/stdout
    log_stream_prefix  ${SERVICE_NAME}
    auto_create_group  true
    log_key            log

# Apacheエラーログ
[OUTPUT]
    Name               cloudwatch_logs
    Match              apache-stderr-*
    region             ${AWS_REGION}
    log_group_name     /ecs/component/mw/apache/stderr
    log_stream_prefix  ${SERVICE_NAME}
    auto_create_group  true
    log_key            log

# すべてのFILTERにマッチしなかったログ（想定外）
[OUTPUT]
    Name               cloudwatch_logs
    Match              *-firelens-*
    region             ${AWS_REGION}
    log_group_name     /ecs/component/unmatched
    log_stream_prefix  ${SERVICE_NAME}
    auto_create_group  true
    log_key            log
